<!doctype html>
<html>

<head>
   <script src="ext/jquery.min.js"></script>

   <!-- original dev on 3.7 -->
   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

   <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
   <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
   <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

   <link rel="stylesheet" href="main.css" />
   <style>
      #root {
         height: 100%;
         font-size: 16px;
      }

      #dfbody {
         height: 100%;
         display: flex;
         flex-direction: row;
      }

      #leftPane {
         /* no shrink, no grow, use content size.*/
         flex: none;
         overflow-y: auto;
      }

      ul {
         border: solid 4px #0cc;
         margin: 4px;
         border-radius: 10px;
         padding: 0;
         width: fit-content;
      }

      li {
         background-color: #222;
         padding: 1px;
         margin: 2px;
         font-family: monospace;
         color: #888;
      }

      li.clickable {
         background-color: #033;
         cursor: pointer;
         color: #0cc;
      }

      li:hover {
         background-color: #444;
      }

      li.clickable:hover {
         background-color: #055;
      }

      div.button {
         background-color: #033;
         cursor: pointer;
         color: #0cc;
         padding: 2px;
         border: solid 2px #088;
         margin: 2px;
         border-radius: 7px;
         display: inline-block;
      }

      div.button:hover {
         background-color: #055;
      }

      #canvasContainer {
         position: relative;
         height: 100%;
         width: 100%;
      }

      #chartCanvas {
         background-color: #002;
      }

      a:link,
      a:visited,
      a {
         color: #088;
      }
   </style>
</head>

<body>

   <div id="root"></div>

   <script type="text/babel">

      function FormatTimeMS(ms) {
         return new Date(ms).toISOString().substring(11).substring(0, 8);
      }

      function DurationSpecToMS(spec, _default) {
         // by replacing numeric strings with an asterisk, i should always get a
         // string like, *ms, where the suffix is at the end, and there's exactly 1
         // asterisk. it's a quick&dirty way to check syntax,
         if (!spec) {
            return _default || 0;
         }
         spec = spec.toLowerCase().trim();
         if (spec == '0') {
            return 0;
         }
         const parts = spec.split(/[0-9]+/g);
         if (parts.length !== 2) { return 0; } // there should only be 1 numeric "word", so splitting gives 2
         // maybe empty strings on either side.

         const num = parseInt(spec);
         const suffix = parts[1].trim();

         if (suffix === 'ms') {
            return num;
         }
         if (['s', 'sec', 'second', 'seconds'].some(s => suffix === s)) {
            return num * 1000;
         }
         if (['m', 'min', 'mins', 'minute', 'minutes'].some(s => suffix === s)) {
            return num * 1000 * 60;
         }
         if (['h', 'hr', 'hrs', 'hour', 'hours'].some(s => suffix === s)) {
            return num * 1000 * 60 * 60;
         }
         if (['d', 'day', 'days'].some(s => suffix === s)) {
            return num * 1000 * 60 * 60 * 24;
         }

         return null;
      }

      // props: subscription, onSelectIntegration
      class Subscription extends React.Component {
         constructor(props) {
            super(props);
            this.state = {
            }
         }

         onClickIntegration(integration) {
            this.props.onSelectIntegration(this.props.subscription, integration);
         }

         render() {
            const integrationSelector = this.props.subscription.integrations.map(integration => {
               console.assert(!!integration.integrationID);
               if (integration.dataSource && integration.dataSource.type === 'HistogramDataSource')
                  return (<li className="clickable" key={integration.integrationID} onClick={() => this.onClickIntegration(integration)}>{integration.integrationID}</li>);
               return (<li key={integration.integrationID}>{integration.integrationID}</li>);
            });
            return (
               <li className="subscription" key={this.props.subscription.id}><div>{this.props.subscription.id} {this.props.subscription.title}</div>
                  <ul>
                     {integrationSelector}
                  </ul>
               </li>
            );
         }
      }


      class RootArea extends React.Component {
         constructor(props) {
            super(props);
            this.state = {
               data: null,
               dataLastReceived: null,
               subscriptionID: null,
               integrationID: null,
               displayDurationText: "4h",
               displayDurationMS: DurationSpecToMS("4h"),
               showFiller: false,
            }
            this.chart = null;

            this.RefreshData();
         }

         RefreshData() {
            $.ajax({
               type: 'GET',
               url: '/activityHookData.json',
               dataType: 'json',
               success: data => this.OnData(data)
            });
         }

         OnData(data) {
            data.subscriptions.sort((a, b) => a.title > b.title ? 1 : -1);
            console.log(`completed downloading data ${data.length}`);
            this.setState({
               data,
               dataLastReceived: new Date(),
            });
         }

         onSelectIntegration = (subscription, integration) => {
            this.setState({
               subscriptionID: subscription.id,
               integrationID: integration.integrationID,
            });
         }

         setDuration(str) {
            const ms = DurationSpecToMS(str);
            if (ms) { // validate before refreshing
               this.setState({
                  displayDurationMS: ms
               });
            }
            this.setState({
               displayDurationText: str,
            });
         }

         onDisplayDurationChange = (e) => {
            setDuration(e.target.value);
         }

         ToggleRemoveFiller() {
            this.setState({ showFiller: !this.state.showFiller });
         }

         UpdateChart() {
            if (!this.state.integrationID) return;
            if (!this.state.subscriptionID) return;
            if (!this.state.data) return;

            const subscription = this.state.data.subscriptions.find(s => s.id === this.state.subscriptionID);
            console.assert(!!subscription);
            const integration = subscription.integrations.find(i => i.integrationID === this.state.integrationID);
            console.assert(!!integration);

            // filter bins to time.
            const maxAgeMS = DurationSpecToMS(this.state.displayDurationText);
            const bins = integration.dataSource.bins.filter(b => b.partitionEndAgeMS <= maxAgeMS && (!b.isFiller || this.state.showFiller));

            const now = Date.now();
            const labels = bins.map(b => FormatTimeMS(b.partitionEndAgeMS));
            const binData = bins.map(b => b.value);
            const cumulativeData = bins.map(b => b.cumulativeValue);

            const dataSet = {
               labels,
               datasets: [
                  {
                     label: `Bin data for ${subscription.title} ==> ${integration.integrationID}`,
                     data: binData,
                     backgroundColor: '#0cc',
                     barPercentage: 1.0,
                     categoryPercentage: 1.0,
                     yAxisID: 'yAxis0',
                  },
                  {
                     label: `Cumulative ${subscription.title} ==> ${integration.integrationID}`,
                     data: cumulativeData,
                     backgroundColor: '#666',
                     barPercentage: 1.0,
                     categoryPercentage: 1.0,
                     yAxisID: 'yAxis1',
                  },
               ]
            };

            // possibility to update data & chart.update, but i found it doesn't correct some things like scale
            this.chart && this.chart.destroy();

            var chartCanvas = document.getElementById('chartCanvas');
            this.chart = new Chart(chartCanvas.getContext("2d"), {
               type: 'bar',
               data: dataSet,
               options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  legend: {
                     display: true,
                     labels: {
                        fontSize: 24, // https://www.chartjs.org/docs/2.9.4/configuration/legend.html
                        fontColor: '#0cc'
                     }
                  },
                  animation: {
                     duration: 200 // general animation time
                  },
                  scales: {
                     yAxis0: {
                        type: 'linear'
                     },
                     yAxis1: {
                        type: 'linear'
                     }
                  },

                  plugins: {
                     legend: {
                        labels: {
                           font: { size: 24 }
                        }
                     },
                     tooltip: {
                        callbacks: {
                           title: (context) => '',
                           label: (context) => `${context.formattedValue} notes @ age ${context.label}`,
                        },
                        titleFont: {
                           size: 28
                        },
                        bodyFont: {
                           size: 28
                        },
                     }
                  }
               }
            });
         }

         render() {
            const subscriptionList = this.state.data && this.state.data.subscriptions.map(subscription => (
               <Subscription key={subscription.id} subscription={subscription} onSelectIntegration={this.onSelectIntegration} />
            ));

            setTimeout(() => this.UpdateChart(), 1);

            return (
               <div id="dfbody">
                  <div id="leftPane">
                     <div style={{ position: "sticky", backgroundColor: "#000000cc", top: 0, padding: "10px" }}>
                        <a href="/activityHookData.json" target="_blank">/activityHookData.json</a>
                        <br />
                        <div className="button" onClick={() => { this.RefreshData(); }}>Refresh</div>
                        <div className="button" onClick={() => { this.ToggleRemoveFiller(); }}>{this.state.showFiller ? "Showing filler bins" : "Hiding filler bins"}</div>
                        <div>Last refreshed: {this.state.dataLastReceived && this.state.dataLastReceived.toLocaleTimeString()}</div>
                        <div className="button" onClick={() => { this.setDuration("3m"); }}>3m</div>
                        <div className="button" onClick={() => { this.setDuration("10m"); }}>10m</div>
                        <div className="button" onClick={() => { this.setDuration("30m"); }}>30m</div>
                        <div className="button" onClick={() => { this.setDuration("1h"); }}>1h</div>
                        <div className="button" onClick={() => { this.setDuration("2h"); }}>2h</div>
                        <br />
                        <div className="button" onClick={() => { this.setDuration("4h"); }}>4h</div>
                        <div className="button" onClick={() => { this.setDuration("8h"); }}>8h</div>
                        <div className="button" onClick={() => { this.setDuration("12h"); }}>12h</div>
                        <div className="button" onClick={() => { this.setDuration("24h"); }}>24h</div>
                        <br />
                        <input type="text" style={{ width: "50px" }} value={this.state.displayDurationText} onChange={this.onDisplayDurationChange} /> display duration
                     </div>
                     <ul>{subscriptionList}</ul>
                  </div>
                  <div id="canvasContainer">
                     <canvas id="chartCanvas"></canvas>
                  </div>
               </div>
            );
         }
      }



      ReactDOM.render(
         <RootArea />,
         document.getElementById('root')
      );



   </script>

</body>

</html>